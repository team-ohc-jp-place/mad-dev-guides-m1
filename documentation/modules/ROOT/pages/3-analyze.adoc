= 3. 分析 – 25分
:imagesdir: ../assets/images

== 本演習の目標

前コースの *アセスメント* 演習で学習したように、モダナイゼーションの問題における、実際のコード行を特定し、モダナイゼーションプロジェクトの時間と労力を見積もる必要があるため、レガシーアプリケーションを分析する必要があります。
 
本演習の目標は、MTAの `分析` 機能を使用してソースコードとプロパティに対してスキャンを実施し、 _Customers_ のアプリケーションを分析することです。そして分析実施後、分析レポートを確認し、実際にコード修正に取り掛かります。

MTAの _分析_ は以下のような場面でご活用いただけます。 

* 計画および作業見積り
* マイグレーションに関する問題点の洗い出しと解決策の提示
* 詳細な分析結果のレポート

そして、以下のような機能をご利用いただけます。

* 組み込みルールとマイグレーションパス
* ルールの拡張性およびカスタマイズ性
* ソースコードやアプリケーションアーカイブに対する分析

詳細については、 https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/6.0/html-single/introduction_to_the_migration_toolkit_for_applications/index#new-mta-features_getting-started-guide[MTA Features] の機能を参照ください。

== 3.1. MTAを使用した「Customers」アプリケーションの分析

はじめに、 link:https://gitea.%SUBDOMAIN%/%USERID%/modern-app-dev[Gitea リポジトリ^] から、 `modern-app-dev` ポジトリをローカルシステムにダウンロード、もしくはgit cloneコマンドを実行する必要があります。以前、GitHubを使用した経験がある方であれば、このGiteaのインターフェイスは、とても馴染みやすいと思います。

image::gitea-repo.png[gitea-repo]

[NOTE]
====
また、以下の認証情報でGiteaリポジトリにログインできます。

* Username - `%USERID%`
* Password - `{openshift-password}`
====

プロジェクトをローカルファイルシステムにダウンロードもしくは複製後、プロジェクトの展開を行い、 *packages-mta* フォルダに `customers-tomcat.war` ファイルが存在しているかご確認ください。このファイルは、分析を実施するために、MTAにアップロードするファイルとなります。

MTA Web Consoleの `Application inventory` ページに戻り、 `Analysis` タブを選択してください。

`Customers` アプリケーションを選択後、 `Analyze` ボタンが有効になりますため、こちらをクリックしてください。

image::application-analysis.png[application-analysis]

=== 3.1.1. 分析モード

分析モードのポップアップウィンドウから、 `Upload local binary` オプションを選択します。選択後、 *customers-tomcat.war* ファイルをドラッグ＆ドロップするか、ローカルファイルシステムからアップロードしてください。

image::add-applications.png[Add applications]

`Next` をクリックしてください。

[NOTE]
====
アップロード完了後、画面右上に、以下のポップアップメッセージが表示されたかご確認ください。アップロード完了まで数秒かかります。

image::upload-success.png[upload-success]
====

=== 3.1.2. ターゲットの設定

アップロードの正常完了後、変換対象のオプションが表示されます。ここでは、移行先に応じて、移行対象を選択します。

本演習では、移行先はLinuxコンテナのため、Windowsファイルシステムのパスなど、コンテナやLinuxとの不整合の問題を避けるために、健全性チェックを行います。また、プロプラエティなJDKディストリビューションへの依存性の排除を検討するため、OpenJDKをターゲットとして選択します。

ターゲットとして `Containers`, `Linux`, `OpenJDK` をクリックしてください。

image::configure-analysis-checked.png[Configure Analysis]

`Next` をクリックしてください。

Select `Application and internal dependencies only` for the scope of dependencies.
依存関係の範囲に `Application and internal dependencies only` for the scope of dependencies. を選択します。

image::packages.png[Select packages]

`Next` をクリックしてください。

=== 3.1.3. 詳細設定

依存関係の範囲を選択後、カスタムルールのオプションが表示されます。

image::custom-rules.png[Custom rules]

MTAのAnalysisでは、分析にカスタムルールエンジンが使用されます。さまざまなマイグレーションパスをサポートするために、多くのルールが最初から用意されていますが、必要に応じて、このルールを拡張することも可能です。カスタムルールは非常に簡単なXML構文で開発でき、分析の一部として使用できます。Globexで使用されていたと判明している、特定のライブラリの使用用途を検出し、そのライブラリを削除するために実行すべき変更を提案するカスタムルールを何種類か提供しています。

`Add Rule` をクリックして、ファイルシステムにダウンロード済みの *customrules* ディレクトリにあるカスタムルール(`corporate-framework-config.windup.xml`)をアップロードしてください。

ファイルをドラッグ＆ドロップするか、ローカルファイルシステムからアップロードしてください。

[NOTE]
====
MacOSで `.windup.xml` ファイルをアップロードする場合は、ポップアップウィンドウのファイルエクスプローラー上でファイルを選択するのではなく、ドラッグ＆ドロップでファイルをアップロードする必要があります。
====

image::upload-custom-rule.png[upload-custom-rule]

ファイルのドラッグ＆ドロップ後、 `Add` をクリックしてください。クリック後、カスタムルールが追加されていることを確認してください。 `Next` をクリックします。

image::enable-custom-rule.png[enable-custom-rule]

次に、分析の微調整オプションが表示されますが、本演習では、デフォルトのオプションのままとします。

image::fine-tune.png[Fine tuning]

`Next` をクリックしてください。

最後に、分析の構成についてまとめてご紹介します。

image::finish-project.png[Finish project]

`Run` をクリックしてください。

「Run」をクリック後、分析処理が始まり、完了後に分析レポートにアクセスできるようになります。分析処理が完了するまで、お待ちください。

分析処理の完了後、左のキャレットから「Customers」アプリケーションを展開します。その後、 `Report` をクリックしてください。

[NOTE]
====
分析の実行前に、Windup用のコンテナイメージのダウンロードが必要となるため、分析に数分かかる場合があります。
====

image::active-analysis.png[Active analysis]

== 3.2. レポートの理解

ダッシュボードでは、アプリケーションのマイグレーション作業全体を俯瞰することができます。ここでは、以下のようにまとめられています。

* カテゴリー別のインシデントとストーリーポイント
* 提案された変更点のLOE別インシデントとストーリーポイント
* パッケージごとのインシデント

[NOTE]
ストーリーポイントとは、アジャイルソフトウェア開発でよく使われる抽象的な指標で、機能や変更を実装するために必要な相対的な労力レベル（LOE）を見積もるためのものです。Migration Toolkit for Applicationは、ストーリーポイントを用いて、特定のアプリケーション構成やアプリケーション全体のマイグレーションに必要なLOEを表示します。マイグレーション対象のアプリケーションの規模や複雑さによって、LOEは大きく異なります。

レポート作成の完成後、リンクをクリックしてレポートにアクセスします。 `customers-tomcat.war` アプリケーションをクリックしてください。

image::report-view.png[View report]

レポートには、アプリケーションに関するあらゆる情報、例として、動作環境、依存関係、そして最も重要な情報として、修正すべき問題が記載されています。

image::report-dashboard.png[report dashboard]

`Issues` タブをクリックしてください。

`Issue` リストでは、ターゲットランタイム上でアプリケーションが正常に実行されるのを妨げる可能性のある問題のリストが表示されます。この例では、アプリケーションの場合、対処すべき必須事項がいくつかあることが分かります。

`Hard coded IP address` をクリックします。

表示されている問題を選択すると、対象の問題が検出された場所を確認し、解決方法のヒントを見ることができます。設定ファイルで、固定IPがいくつか使用されているようです。この設定はクラウド環境、コンテナ環境では、適さないものとなります。

image::report-hint.png[report hint]
 
 `File system issue` をクリックしてください。

この例では、コンフィグライブラリから送られてくるクラスで問題が検出されたようです。バイナリを分析しているため、依存関係も分析対象となります。

image::report-hint-fs.png[report hint file system]

`Legacy configuration issue` をクリックしてください。

この例では、カスタムルールがトリガーされ、ソースコードに問題が見つかったようです。このルールは、カスタム設定ライブラリの使用を検出し、それを修正するために必要なヒントが得られます。

image::report-hint-custom.png[report hint custom rule]

`io.konveyor.demo.ordermanagement.config.PersistenceConfig` をクリックしてください。

image::report-code.png[report code]

クリック後、ソースコードのどこに問題があるのか、正確に把握できます。

== まとめ

以上で、レガシーアプリケーションの分析に成功し、どのようなマイグレーションの問題があるのかを知ることができました。次のモジュールでは、特定した問題を解決するために、アプリケーションのリファクタリングを実施します。そしてその後、モダナイゼーションされたアプリケーションを、Red Hat OpenShift にデプロイします。次のモジュールに移動してください。
