= 3. 分析 – 25分
:imagesdir: ../assets/images

== 本演習の目標

前コースの *アセスメント* 演習で学習したように、モダナイゼーションプロジェクトの時間と労力を見積もるために、モダナイゼーションの問題が発生するソースコードの行を特定という観点で、レガシーアプリケーションを分析する必要があります。
 
本演習では、MTAの `分析` 機能を使用してソースコードと設定ファイルに対してスキャンを実施し、 _Customers_ のアプリケーションを分析します。そして分析実施後、分析レポートを確認し、実際にコード修正に取り掛かります。

MTAの _分析_ は以下のような場面で活用できます。 

* 計画および作業見積り
* マイグレーションに関する問題点の洗い出しと解決策の提示
* 詳細な分析結果のレポート

そして、以下のような機能を利用できます。

* 組み込みルールとマイグレーションパス
* ルールの拡張性およびカスタマイズ
* ソースコードやアプリケーションアーカイブ(jar/war)に対する分析

詳細については、 https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/6.0/html-single/introduction_to_the_migration_toolkit_for_applications/index#new-mta-features_getting-started-guide[MTA Features] をご参照ください。

== 3.1. MTAを使用した「Customers」アプリケーションの分析

まず初めに、MTAを使いインベントリやアプリケーションを分析する際に、 link:https://gitea.%SUBDOMAIN%/%USERID%/modern-app-dev[Gitea repository^] を参照するように *Gitリポジトリ* を設定する必要があります。

*管理* ビューで、 *Repositories > Git* を選択します。 *Consume insecure Git repositories* トグルを右に切り替えます。

image::mta-admin-git.png[admin git]

[NOTE]
====
以下の認証情報でGiteaリポジトリにログインできます。

* Username - `%USERID%`
* Password - `{openshift-password}`
====

Go back to the `Application inventory` page in the *Migration* perspective. Click on pencil (edit) icon for the customers inventory.

Update application with the following source code information.

* Repository type - `Git`
* Source Repository - `https://gitea.%SUBDOMAIN%/%USERID%/modern-app-dev.git`
* Branch - `main`
* Root path - `package-legacy`

image::application-update-git.png[application-update-git]

Select `Save`.

Select the `Analysis` tab. When you click on the `Customers` application, `Analyze` button will be enabled. Then, click on *Analyze*.

image::application-analysis.png[application-analysis]

=== 3.1.1. 分析モード

Select Source dode in Analysis mode popup.

image::add-applications.png[Add applications]

`Next` をクリックしてください。

=== 3.1.2. ターゲットの設定

アップロードの正常完了後、変換対象のオプションが表示されます。ここでは、移行先に応じて、移行対象を選択します。

本演習では、移行先はLinuxコンテナのため、Windowsファイルシステムのパスなど、コンテナやLinuxとの不整合の問題を避けるために、健全性チェックを行います。また、プロプライエタリなJDKディストリビューションへの依存性の排除を検討するため、OpenJDKをターゲットとして選択します。

ターゲットとして `Containers`, `Linux`, `OpenJDK` をクリックしてください。

image::configure-analysis-checked.png[Configure Analysis]

`Next` をクリックしてください。

依存関係の範囲に `Application and internal dependencies only` を選択します。

image::packages.png[Select packages]

`Next` をクリックしてください。

=== 3.1.3. 詳細設定

依存関係の範囲を選択後、カスタムルールのオプションが表示されます。

image::custom-rules.png[Custom rules]

MTAのAnalysisでは、分析にカスタムルールエンジンが使用されます。さまざまなマイグレーションパスをサポートするために、多くのルールが最初から用意されていますが、必要に応じて、このルールを拡張することも可能です。カスタムルールは非常に簡単なXML構文で開発でき、分析の一部として使用できます。Globexで使用されていたと判明している、特定のライブラリの使用用途を検出し、そのライブラリを削除するために実行すべき変更を提案するカスタムルールを何種類か提供しています。

Key in the following information in the repository page.

* Repository type - `Git`
* Source Repository - `https://gitea.%SUBDOMAIN%/%USERID%/modern-app-dev.git`
* Branch - `main`
* Root path - `customrules`
* Associated credentials - `None`

[NOTE]
====
In case you don't see `None` in the `Associated credentials`, please leave it since the field is not mandatory.
====

image::add-repository-customrules.png[add-repository-customrules]

Click on `Next`.

Next, you will be presented with options to fine tune the analysis. For now we will stick with the default options.

image::fine-tune.png[Fine tuning]

Click on `Next`.

Lastly, we are presented with a summary of the configuration for our analysis.

image::finish-project.png[Finish project]

Click on `Run`.

The analysis begins, and once it is finished you will be able to access the reports. Stay on this view until the analysis is finished.

Once it finishes, select *Customers* application. Then click on `Report` in the *Reports* tab on the right.

[NOTE]
====
The analysis may take a few minutes as it must pull container images for Windup before executing the analysis.
====

image::active-analysis.png[Active analysis]

== 3.2. レポートの理解

ダッシュボードでは、アプリケーションのマイグレーション作業全体を俯瞰することができます。ここでは、以下のようにまとめられています。

* カテゴリーごとのインシデントとストーリーポイント
* 提案された変更点の努力水準(LOE)ごとのインシデントとストーリーポイント
* パッケージごとのインシデント

[NOTE]
ストーリーポイントとは、アジャイルソフトウェア開発でよく使われる抽象的な指標で、機能や変更を実装するために必要な相対的な努力水準(LOE)を見積もるためのものです。Migration Toolkit for Applicationは、ストーリーポイントを用いて、特定のアプリケーション構成やアプリケーション全体のマイグレーションに必要な努力水準(LOE)を表示します。マイグレーション対象のアプリケーションの規模や複雑さによって、努力水準(LOE)は大きく異なります。

レポート作成の完成後、リンクをクリックしてレポートにアクセスします。 `customers-tomcat.war` アプリケーションをクリックしてください。

image::report-view.png[View report]

レポートには、アプリケーションに関する動作環境、依存関係などの情報、そして最も重要な情報として、修正すべき問題が記載されています。

image::report-dashboard.png[report dashboard]

`Issues` タブをクリックしてください。

`Issue` リストでは、ターゲットランタイム上でアプリケーションが正常に実行されるのを妨げる可能性のある問題のリストが表示されます。この例では、アプリケーションの場合、対処すべき必須事項がいくつかあることが分かります。

`Hard coded IP address` をクリックします。

表示されている問題を選択すると、対象の問題が検出された場所を確認し、解決方法のヒントを見ることができます。設定ファイルで、固定IPがいくつか使用されているようです。この設定はクラウド環境、コンテナ環境では、適さないものとなります。

image::report-hint.png[report hint]
 
`File system issue` をクリックしてください。

この例では、コンフィグライブラリから送られてくるクラスで問題が検出されたようです。バイナリを分析しているため、依存関係も分析対象となります。

image::report-hint-fs.png[report hint file system]

`Legacy configuration issue` をクリックしてください。

この例では、カスタムルールがトリガーされ、ソースコードに問題が見つかったようです。このルールは、カスタム設定ライブラリの使用を検出し、それを修正するために必要なヒントが得られます。

image::report-hint-custom.png[report hint custom rule]

`io.konveyor.demo.ordermanagement.config.PersistenceConfig` をクリックしてください。

image::report-code.png[report code]

クリック後、ソースコードのどこに問題があるのか、正確に把握できます。

== まとめ

以上で、レガシーアプリケーションの分析に成功し、どのようなマイグレーションの問題があるのかを知ることができました。次のモジュールでは、特定した問題を解決するために、アプリケーションのリファクタリングを実施します。そしてその後、モダナイゼーションされたアプリケーションを、Red Hat OpenShift にデプロイします。次のモジュールに移動してください。
